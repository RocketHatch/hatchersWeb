var sessionsList = new Array();
var searchHandle = {};
var clearHandle = {};
var PURGEOVERMINUTES = 20;

function Session(sid) {
  var id;
  if (sid) {
    this.id = sid;
  } else {
    //this.id = (new Date().getTime()*Math.random()*23);
    this.id = {com1:new Date().getTime(),com2:Math.random()};
  }
  var member_id = null;
  var lastHit = null;
}

var getSession = function(sessionId) {
   var session;
  if (!sessionId) {
    session = new Session();
    sessionsList.push(session);
  } else {
    for (var i=0;i<sessionsList.length;i++) {
      //var tmpObj = ;
      if ( sessionsList[i].id.com1 === sessionId.com1 && 
          sessionsList[i].id.com2 === sessionId.com2) {
        session = sessionsList[i];
      }
    }
  }
  return session;
}

var listSessions = function() {
  if (sessionsList) {
    for (var i=0;i<sessionsList.length;i++) {
      console.log("[sessions] " + sessionsList[i].id.com2 +
	              " list idx: " + i +
                  " user id: " + sessionsList[i].member_id +
                  " lastHit: " + sessionsList[i].lastHit);
    }
  } else {
    console.log("[sessions:41,5] No active sessions");
  }
  return sessionsList;
}

var deleteSession = function(sessionId, indx) {
  var idx = -1;
  if (sessionId != null) {
    idx = findIndex(sessionId);
  } else if (indx != null) {
    idx = indx;
  }
  if (idx > -1) {  
    sessionsList = removeSession(idx);
  }
}

var findIndex = function(sessionId) {
  var r, i = -1;
  var found = false;
  i++;
  while (i<sessionsList.length && !found) {
      found = ( sessionsList[i].id.com1 === sessionId.com1 && 
          sessionsList[i].id.com2 === sessionId.com2);
      if (found) r = i;
      i++;
  }
  return r;
}

var findIndexByUser = function(id) {
  var r = -1;
  var found = false;
  var i = 0;
  while (i<sessionsList.length && !found) {
      found = ( sessionsList[i].member_id+'' === id+'');
      if (found) r = i;
      i++;
  }
  return r;
}

var removeSession = function(idx) {
  var nidx = 0;
  var newArray = new Array();
  for (var i=0;i<sessionsList.length;i++) {
    if ( i === idx ) {
      // skip nidx--;
	  console.log("removing at idx " + idx);
    } else {
      newArray[nidx] = sessionsList[i];
      nidx++;
    }
  }
  return newArray;
}

var purgeSessions = function() {
  if (sessionsList.length > 0) {
    var currentTime = new Date().getTime();
    var nidx = 0;
    var newArray = new Array();
  
    for (var i=0;i<sessionsList.length;i++) {
	  //console.log('currentTime = ' + currentTime);
	  //console.log('last hit = ' + sessionsList[i].lastHit);
	  //console.log('difference = ' + (currentTime - sessionsList[i].lastHit));
	  if ( sessionsList[i].user && ((currentTime - sessionsList[i].lastHit) < (PURGEOVERMINUTES*60*1000) ) ) {
	    newArray[nidx] = sessionsList[i];
	    nidx++;
	  }
    }
	console.log("Removed " + (i-nidx) + " sessions. " + newArray.length + " sessions remaining");
    sessionsList = newArray;
  } else {
    console.log("No active sessions");
  }
}

exports.getSession = getSession;
exports.findIndexByUser  = findIndexByUser;
exports.listSessions = listSessions;
exports.deleteSession = deleteSession;
exports.purgeSessions = purgeSessions;
exports.Session = Session;

